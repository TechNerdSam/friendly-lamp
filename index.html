<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salam Check - V√©rificateur Halal/Haram</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Style de base pour un design moderne */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117;
            color: #C9D1D9;
        }

        /* Effet de verre (glassmorphism) pour la barre de recherche et les cartes */
        .glass-effect {
            background: rgba(22, 27, 34, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Effet de surbrillance au survol */
        .card-hover-effect {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-hover-effect:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 0 25px rgba(45, 212, 191, 0.2);
        }
        
        /* Animation d'apparition pour les √©l√©ments de la liste */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Animation du spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #2DD4BF;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- En-t√™te -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-6xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-teal-300 to-sky-400 mb-2">
                Salam Check
            </h1>
            <p class="text-lg text-gray-400">Les derniers produits v√©rifi√©s pour vous, en temps r√©el.</p>
        </header>

        <!-- Filtres -->
        <div class="sticky top-4 z-10 p-4 mb-8 rounded-xl glass-effect shadow-lg">
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <div id="filterButtons" class="flex items-center justify-center gap-2 flex-wrap">
                     <button class="filter-btn active bg-teal-500 text-white" data-status="all">Tous</button>
                     <button class="filter-btn" data-status="Halal">Halal</button>
                     <button class="filter-btn" data-status="Haram">Haram</button>
                     <button class="filter-btn" data-status="Douteux">Douteux</button>
                </div>
            </div>
        </div>
        
        <!-- Zone de contenu principal -->
        <main id="contentArea">
            <!-- Spinner de chargement -->
            <div id="loader" class="flex justify-center py-12">
                <div class="spinner"></div>
            </div>
            
            <!-- Grille des produits -->
            <div id="productList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les produits seront ins√©r√©s ici par JavaScript -->
            </div>
            
            <!-- Message si aucun r√©sultat -->
            <div id="noResults" class="hidden text-center py-12">
                 <p class="text-xl text-gray-500">Aucun produit ne correspond √† votre recherche.</p>
            </div>
        </main>

        <!-- Pied de page -->
        <footer class="text-center mt-12 py-6 border-t border-gray-800">
            <p class="text-gray-500 text-sm">&copy; 2025 Salam Check. Propuls√© par l'API de Open Food Facts. Les informations sont fournies √† titre indicatif et la classification est automatis√©e. En cas de doute, veuillez consulter un organisme de certification.</p>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const contentArea = document.getElementById('contentArea');
        const productList = document.getElementById('productList');
        const filterButtonsContainer = document.getElementById('filterButtons');
        const noResults = document.getElementById('noResults');
        const loader = document.getElementById('loader');

        // --- State Management ---
        let currentSearchResults = [];

        // --- Styles for statuses ---
        const statusStyles = {
            'Halal': { badge: 'bg-teal-500/20 text-teal-300 border-teal-500', glow: 'shadow-[0_0_15px_rgba(45,212,191,0.3)]' },
            'Haram': { badge: 'bg-red-500/20 text-red-400 border-red-500', glow: 'shadow-[0_0_15px_rgba(239,68,68,0.3)]' },
            'Douteux': { badge: 'bg-amber-500/20 text-amber-400 border-amber-500', glow: 'shadow-[0_0_15px_rgba(245,158,11,0.3)]' }
        };

        // --- Classification Logic ---
        const haramIngredients = ['porc', 'saindoux', 'g√©latine de porc', 'lardons', 'jambon', 'bacon', 'vin', 'alcool', 'bi√®re', 'liqueur', '√©thanol', 'cochon', 'g√©latine animale', 'cochenille', 'e120'];
        const doubtfulIngredients = ['g√©latine', 'pr√©sure', 'e471', 'e472', 'mono et diglyc√©rides', 'graisses animales', 'collag√®ne', 'lactos√©rum'];

        const determineStatus = (product) => {
            const ingredients = (product.ingredients_text_fr || "").toLowerCase();
            const labels = (product.labels || "").toLowerCase();
            const name = (product.product_name || "").toLowerCase();
            const additives = product.additives_tags || [];
            const analysis = product.ingredients_analysis_tags || [];

            if (!ingredients && !labels) {
                return { status: "Douteux", reason: "Informations insuffisantes pour d√©terminer le statut. V√©rifiez l'emballage." };
            }
            if (labels.includes('halal')) {
                return { status: "Halal", reason: "Ce produit poss√®de une certification Halal." };
            }
            if (name.includes('bi√®re') || name.includes('vin') || name.includes('whisky') || name.includes('rhum') || name.includes('vodka') || name.includes('liqueur')) {
                return { status: "Haram", reason: `Ceci est une boisson alcoolis√©e.` };
            }

            if (additives.includes('en:e120')) {
                return { status: "Haram", reason: `Contient du colorant E120 (cochenille), un ingr√©dient consid√©r√© comme Haram.` };
            }

            for (const item of haramIngredients) {
                if (ingredients.includes(item)) {
                    return { status: "Haram", reason: `Contient "${item}", un ingr√©dient consid√©r√© comme Haram.` };
                }
            }
            
            if (analysis.includes('en:vegan') || analysis.includes('en:vegetarian')) {
                return { status: "Halal", reason: "Produit compatible V√©g√©talien/V√©g√©tarien et ne contient pas d'alcool." };
            }

            for (const item of doubtfulIngredients) {
                if (ingredients.includes(item)) {
                    if (item === 'g√©latine' && (ingredients.includes('g√©latine v√©g√©tale') || ingredients.includes('g√©latine de poisson') || ingredients.includes('g√©latine bovine halal'))) {
                        continue;
                    }
                     if (item === 'lactos√©rum' && labels.includes('fromage')) {
                         return { status: "Douteux", reason: `Contient du lactos√©rum (petit-lait) dont la pr√©sure peut √™tre d'origine animale non-halal.` };
                    }
                    return { status: "Douteux", reason: `Contient "${item}", un ingr√©dient dont l'origine (animale ou v√©g√©tale) doit √™tre v√©rifi√©e.` };
                }
            }
            const categories = (product.categories || "").toLowerCase();
             if (categories.includes('eaux') || categories.includes('fruits') || categories.includes('l√©gumes') || categories.includes('p√¢tes alimentaires')) {
                if (!ingredients.length || ingredients.includes('bl√©') || ingredients.includes('eau')) {
                     return { status: "Halal", reason: "Produit de base ne contenant pas d'ingr√©dients transform√©s suspects." };
                }
            }

            return { status: "Douteux", reason: "Produit non certifi√©. L'analyse des ingr√©dients ne permet pas de conclure. La v√©rification est recommand√©e." };
        };

        const getIconForProduct = (product) => {
            const categories = (product.categories || "").toLowerCase();
            if (categories.includes('boissons')) return 'ü•§';
            if (categories.includes('viandes')) return 'ü•©';
            if (categories.includes('fromages')) return 'üßÄ';
            if (categories.includes('p√¢tes')) return 'üçù';
            if (categories.includes('confiseries') || categories.includes('bonbons')) return 'üç¨';
            if (categories.includes('g√¢teaux')) return 'üç∞';
            if (categories.includes('poissons')) return 'üêü';
            if (categories.includes('pains')) return 'üçû';
            if (categories.includes('chocolats')) return 'üç´';
            return 'üõí'; // Default icon
        }

        // --- API & Display Functions ---
        const displayProducts = (productsToDisplay) => {
            productList.innerHTML = '';
            
            noResults.classList.toggle('hidden', productsToDisplay.length > 0);

            productsToDisplay.forEach((product, index) => {
                const { status, reason } = determineStatus(product);
                const style = statusStyles[status];
                const icon = getIconForProduct(product);

                const productCard = document.createElement('div');
                productCard.className = `flex flex-col p-5 rounded-xl border glass-effect card-hover-effect fade-in ${style.glow}`;
                productCard.style.animationDelay = `${index * 50}ms`;

                productCard.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h2 class="text-xl font-bold text-white">${product.product_name || 'Nom indisponible'}</h2>
                            </div>
                            <div class="text-4xl">${icon}</div>
                        </div>
                        <div class="mb-4">
                            <span class="text-xs font-semibold inline-block py-1 px-3 rounded-full border ${style.badge}">
                                ${status}
                            </span>
                        </div>
                        <p class="text-gray-400 text-sm">${reason}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-700/50 text-right">
                        <a href="https://world.openfoodfacts.org/product/${product.code}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-sm font-medium text-teal-400 hover:text-teal-300 transition-colors">
                            Voir la fiche produit
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1.5" viewBox="http://www.w3.org/2000/svg" fill="currentColor">
                              <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                              <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                            </svg>
                        </a>
                    </div>
                `;
                productList.appendChild(productCard);
            });
        };

        const filterAndDisplay = () => {
            const activeStatus = document.querySelector('.filter-btn.active').dataset.status;
            if (activeStatus === 'all') {
                displayProducts(currentSearchResults);
            } else {
                const filtered = currentSearchResults.filter(product => {
                    return determineStatus(product).status === activeStatus;
                });
                displayProducts(filtered);
            }
        };

        const fetchAndUpdateProducts = async () => {
            loader.style.display = 'flex';
            noResults.classList.add('hidden');
            productList.innerHTML = ''; // Clear list before new fetch

            try {
                // Fetch products sorted by last modification date
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/search?sort_by=last_modified_t&page_size=300&fields=product_name,code,image_url,ingredients_text_fr,labels,categories,additives_tags,ingredients_analysis_tags&json=1&countries_tags_fr=france`);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                // Filter for products with essential info
                currentSearchResults = data.products.filter(p => p.product_name && p.ingredients_text_fr && p.image_url);
                
                loader.style.display = 'none';
                if (currentSearchResults.length > 0) {
                    filterAndDisplay();
                } else {
                    noResults.innerHTML = '<p class="text-xl text-gray-500">Aucun produit r√©cent trouv√©. R√©essayez plus tard.</p>';
                    noResults.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Failed to fetch products:", error);
                currentSearchResults = [];
                loader.style.display = 'none';
                noResults.innerHTML = '<p class="text-xl text-red-400">Une erreur est survenue lors de la r√©cup√©ration des produits.</p>';
                noResults.classList.remove('hidden');
            }
        };

        // --- Event Listeners ---
        filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                filterButtonsContainer.querySelector('.filter-btn.active').classList.remove('active', 'bg-teal-500', 'text-white');
                e.target.classList.add('active', 'bg-teal-500', 'text-white');
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (!btn.classList.contains('active')) {
                        btn.className = 'filter-btn px-4 py-2 text-sm font-medium text-gray-300 bg-gray-800/60 rounded-lg hover:bg-gray-700 transition-colors';
                    }
                });
                filterAndDisplay();
            }
        });
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (!btn.classList.contains('active')) {
                    btn.className = 'filter-btn px-4 py-2 text-sm font-medium text-gray-300 bg-gray-800/60 rounded-lg hover:bg-gray-700 transition-colors';
                } else {
                     btn.className = 'filter-btn active bg-teal-500 text-white px-4 py-2 text-sm font-medium rounded-lg transition-colors';
                }
            });

            // Initial fetch
            fetchAndUpdateProducts();

            // Set interval to refresh data every 60 seconds (60000 milliseconds)
            setInterval(fetchAndUpdateProducts, 60000);
        });
    </script>
</body>
</html>

